description: rapid analysis pipeline for LSSTCam
instrument: lsst.obs.lsst.LsstCam
imports:
  - location: $DONUT_VIZ_DIR/pipelines/production/lsstCamScienceSensorRapidAnalysisPipeline_Danish.yaml
    exclude:
      - calcZernikesTask
      - plotAOSTask
      - plotDonutTask
      - plotPsfZernTask
tasks:
  generateDonutDirectDetectTask:
    class: lsst.ts.wep.task.generateDonutDirectDetectTask.GenerateDonutDirectDetectTask
    config:
      donutSelector.sourceLimit: 40
  cutOutDonutsScienceSensorGroupTask:
    class: lsst.ts.wep.task.cutOutDonutsScienceSensorTask.CutOutDonutsScienceSensorTask
    config:
      python: |
        from lsst.ts.wep.task.pairTask import GroupPairer
        config.pairer.retarget(GroupPairer)
      connections.exposures: post_isr_image
      donutStampSize: 200
      initialCutoutPadding: 40
      runPaired: False
  calcZernikesUnpairedTask:
    class: lsst.ts.wep.task.calcZernikesUnpairedTask.CalcZernikesUnpairedTask
    config:
      connections.donutStamps: donutStampsScienceSensor
      donutStampSelector.maxSelect: 20
  aggregateDonutStampsTask:
    class: lsst.donut.viz.AggregateDonutStampsTask
    config:
      maxDonutsPerDetector: 20

# Define pipeline steps
subsets:
  step1a-detectors:
    subset:
      - isr

  step1b-visits:
    subset:
      - generateDonutDirectDetectTask
      - cutOutDonutsScienceSensorGroupTask
      - calcZernikesUnpairedTask
    description: |
      This step processes the input images with ISR,
      finds and cuts out the donut stamps,
      and estimates the Zernike coefficients from the donut pairs.
  step2-visits:
    subset:
      - aggregateZernikeTablesTask
      - aggregateDonutTablesGroupTask
      - aggregateAOSVisitTableTask
      - aggregateDonutStampsTask
    description: |
      AOS Donut visualization plotting tasks. This step generates plots
      (including the pyramid residual and donut gallery) and
      tables for the AOS visit.

steps:
  - label: step1a-detectors
    dimensions: [detector]
  - label: step1b-visits
    dimensions: []
  - label: step2-visits
    dimensions: []