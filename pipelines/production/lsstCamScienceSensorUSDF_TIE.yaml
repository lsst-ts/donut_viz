description: rapid analysis pipeline for LSSTCam
instrument: lsst.obs.lsst.LsstCam
imports:
  # - $DONUT_VIZ_DIR/pipelines/_ingredients/wepDirectDetectScienceGroupPipeline.yaml
  - $DONUT_VIZ_DIR/pipelines/_ingredients/donutVizGroupPipeline.yaml
tasks:
  # isr:
  #   class: lsst.ip.isr.IsrTaskLSST
  #   config:
  #     connections.outputExposure: post_isr_image
  #     # Although we don't have to apply the amp offset corrections, we do want
  #     # to compute them for analyzeAmpOffsetMetadata to report on as metrics.
  #     doAmpOffset: False
  #     ampOffset.doApplyAmpOffset: False
  #     # Turn off slow steps in ISR but mask saturated pixels
  #     doBrighterFatter: False
  #     doSaturation: True
  #     crosstalk.doQuadraticCrosstalkCorrection: False
  #     qa.saveStats: False
  #     doStandardStatistics: False
  #     doInterpolate: False
  #     doVariance: False
  #     doDeferredCharge: False
  #     doDefect: False
  #     doApplyGains: False
  #     doBias: False
  #     doFlat: True
  #     doDark: False
  #     doLinearize: False
  #     doSuspect: False
  #     doSetBadRegions: False
  #     doBootstrap: False
  #     doCrosstalk: False
  #     doITLEdgeBleedMask: False
  # generateDonutDirectDetectTask:
  #   class: lsst.ts.wep.task.generateDonutDirectDetectTask.GenerateDonutDirectDetectTask
  #   config:
  #     connections.exposure: post_isr_image
  #     donutSelector.useCustomMagLimit: True
  #     donutSelector.sourceLimit: 40
  calcZernikesTask:
    class: lsst.ts.wep.task.calcZernikesTask.CalcZernikesTask
    config:
      estimateZernikes.nollIndices: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 20, 21, 22, 27, 28]
      estimateZernikes.convergeTol: 10.0e-9
      estimateZernikes.compGain: 0.75
      estimateZernikes.compSequence: [4, 4, 6, 6, 13, 13, 13, 13]
      estimateZernikes.maxIter: 50
      estimateZernikes.requireConverge: True
      estimateZernikes.saveHistory: False
      estimateZernikes.maskKwargs: { "doMaskBlends": False }
      donutStampSelector.maxFracBadPixels: 2.0e-4
      donutStampSelector.maxSelect: 5

# Define pipeline steps
subsets:
  step1b-visits:
    subset:
      - calcZernikesTask
    description: |
      This step processes the input images with ISR,
      finds and cuts out the donut stamps,
      and estimates the Zernike coefficients from the donut pairs.
  step2-visits:
    subset:
      - aggregateZernikeTablesTask
      - aggregateDonutTablesGroupTask
      - aggregateAOSVisitTableTask
      # - plotAOSTask
      - aggregateDonutStampsTask
      # - plotDonutTask
      # - plotPsfZernTask
    description: |
      AOS Donut visualization plotting tasks. This step generates plots
      (including the pyramid residual and donut gallery) and
      tables for the AOS visit.

steps:
  - label: step1a-detectors
    dimensions: [detector]
  - label: step1b-visits
    dimensions: []
  - label: step2-visits
    dimensions: []
