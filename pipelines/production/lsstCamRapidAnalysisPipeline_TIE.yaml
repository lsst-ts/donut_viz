description: rapid analysis pipeline for LSSTCam
instrument: lsst.obs.lsst.LsstCam
imports:
  - $DONUT_VIZ_DIR/pipelines/_ingredients/wepDirectDetectCwfsPipeline.yaml
  - $DONUT_VIZ_DIR/pipelines/_ingredients/donutVizCwfsPipeline.yaml
tasks:
  calcZernikesTask:
    class: lsst.ts.wep.task.calcZernikesTask.CalcZernikesTask
    config:
      python: |
        from lsst.ts.wep.task import EstimateZernikesTieTask
        config.estimateZernikes.retarget(EstimateZernikesTieTask)
      estimateZernikes.convergeTol: 10.0e-9
      estimateZernikes.compGain: 0.75
      estimateZernikes.compSequence: [4, 4, 6, 6, 13, 13, 13, 13]
      estimateZernikes.maxIter: 50
      estimateZernikes.requireConverge: True
      estimateZernikes.maskKwargs: { "doMaskBlends": False }
      # Need to reset after change in estimateZernikes class
      estimateZernikes.nollIndices:
        [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 22, 23, 24, 25, 26]

# Define pipeline steps
subsets:
  step1a-detectors:
    subset:
      - isr
      - generateDonutDirectDetectTask
      - cutOutDonutsCwfsPairTask
      - reassignCwfsCutoutsPairTask
      - calcZernikesTask
    description: |
      This step processes the input images with ISR,
      finds and cuts out the donut stamps,
      and estimates the Zernike coefficients from the donut pairs.
  step1b-visits:
    subset:
      - aggregateZernikeTablesTask
      - aggregateDonutTablesCwfsTask
      - aggregateAOSVisitTableCwfsTask
      - plotAOSTask
      - aggregateDonutStampsTask
      - plotDonutCwfsTask
      - plotPairingTask
      - plotPsfZernTask
    description: |
      AOS Donut visualization plotting tasks. This step generates plots
      (including the pyramid residual and donut gallery) and
      tables for the AOS visit.
  detector-pair-merge-task:
    - reassignCwfsCutoutsPairTask

steps:
  - label: step1a-detectors
    dimensions: [visit, detector]
  - label: step1b-visits
    dimensions: [visit]
