description: test pipeline for LSSTCam using neural network-based Zernike estimation
instrument: lsst.obs.lsst.LsstCam

tasks:
  isr:
    class: lsst.ip.isr.IsrTaskLSST
    config:
      connections.outputExposure: post_isr_image
      # Although we don't have to apply the amp offset corrections, we do want
      # to compute them for analyzeAmpOffsetMetadata to report on as metrics.
      doAmpOffset: False
      ampOffset.doApplyAmpOffset: False
      # Turn off slow steps in ISR but mask saturated pixels
      doBrighterFatter: False
      doSaturation: True
      crosstalk.doQuadraticCrosstalkCorrection: False
      qa.saveStats: False
      doStandardStatistics: False
      doInterpolate: False
      doVariance: False
      doDeferredCharge: False
      doDefect: False
      doApplyGains: False
      doBias: False
      doFlat: True
      doDark: False
      doLinearize: False
      doSuspect: False
      doSetBadRegions: False
      doBootstrap: False
      doCrosstalk: False
      doITLEdgeBleedMask: False
  calcZernikesNeuralTask:
    class: lsst.ts.wep.task.calcZernikesNeuralTask.CalcZernikesNeuralTask
    config:
      connections.exposure: post_isr_image
      # Model paths set to null for testing (task will use random weights)
      wavenetPath: $TARTS_DATA_DIR/best_finetuned_wavennet.ckpt
      alignetPath: $TARTS_DATA_DIR/best_alignnet_120.ckpt
      aggregatornetPath: $TARTS_DATA_DIR/best_aggregator.ckpt
      datasetParamPath: $TARTS_DIR/python/tarts/dataset_params.yaml
      oodModelPath: $TARTS_DATA_DIR/ood_model.joblib
      # Use CPU for testing
      device: "cpu"
      # Noll indices for Zernike coefficients (Z4-Z28, excluding piston/tip/tilt)
      nollIndices: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28]
  aggregateZernikeTablesTask:
    class: lsst.donut.viz.AggregateZernikeTablesTask
  aggregateDonutStampsUnpairedTask:
    class: lsst.donut.viz.AggregateDonutStampsUnpairedTask
    config:
      maxDonutsPerDetector: 10
  aggregateDonutTablesUnpairedCwfsTask:
    class: lsst.donut.viz.AggregateDonutTablesUnpairedCwfsTask
  aggregateUnpairedAOSVisitTableCwfsTask:
    class: lsst.donut.viz.AggregateAOSVisitTableUnpairedCwfsTask
  plotDonutFitsUnpairedTask:
    class: lsst.donut.viz.PlotDonutFitsUnpairedTask
    config:
      doRubinTVUpload: True
  plotDonutUnpairedCwfsTask:
    class: lsst.donut.viz.PlotDonutUnpairedCwfsTask
    config:
      doRubinTVUpload: True
  plotAOSTask:
    class: lsst.donut.viz.PlotAOSTask
    config:
      doRubinTVUpload: True

# Define pipeline steps
subsets:
  step1a-detectors:
    subset:
      - isr
      - calcZernikesNeuralTask
    description: |
      This step processes the input images with ISR and directly estimates
      Zernike coefficients using the TARTS neural network system.
      No intermediate donut detection or cutting is required.
  step1b-visits:
    subset:
      - aggregateZernikeTablesTask
      - aggregateDonutStampsUnpairedTask
      - aggregateDonutTablesUnpairedCwfsTask
      - aggregateUnpairedAOSVisitTableCwfsTask
      - plotAOSTask
      - plotDonutFitsUnpairedTask
      - plotDonutUnpairedCwfsTask
    description: |
      AOS visualization tasks. This step generates tables
      for the AOS visit using neural network-based Zernike estimates.
steps:
  - label: step1a-detectors
    dimensions: [visit, detector]
  - label: step1b-visits
    dimensions: [visit]
