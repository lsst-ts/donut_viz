description: wep direct detect pipeline
imports:
  - $DONUT_VIZ_DIR/pipelines/_ingredients/aosBaseIsr.yaml

tasks:
  isr:
    class: lsst.ip.isr.IsrTaskLSST
    config:
      connections.outputExposure: post_isr_image
      # Although we don't have to apply the amp offset corrections, we do want
      # to compute them for analyzeAmpOffsetMetadata to report on as metrics.
      doAmpOffset: True
      doDefect: True
      doInterpolate: True
  generateDonutDirectDetectTask:
    class: lsst.ts.wep.task.generateDonutDirectDetectTask.GenerateDonutDirectDetectTask
    config:
      connections.exposure: post_isr_image
      donutSelector.useCustomMagLimit: True
      donutSelector.sourceLimit: 20
      donutSelector.maxFieldDist: 1.725
      measurementTask.nSigmaDetection: 5.0
  cutOutDonutsScienceSensorGroupTask:
    class: lsst.ts.wep.task.cutOutDonutsScienceSensorTask.CutOutDonutsScienceSensorTask
    config:
      python: |
        from lsst.ts.wep.task.pairTask import GroupPairer
        config.pairer.retarget(GroupPairer)
      connections.exposures: post_isr_image
      donutStampSize: 200
      initialCutoutPadding: 40
  calcZernikesTask:
    class: lsst.ts.wep.task.calcZernikesTask.CalcZernikesTask
    config:
      estimateZernikes.nollIndices: [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 18, 19, 20, 21, 22, 27, 28]
      estimateZernikes.saveHistory: False
      donutStampSelector.maxSelect: 16 # Same max density as half size WFS chips (currently at 8 on CWFS)
      donutStampSelector.maxFracBadPixels: 2.0e-4
      donutStampSelector.selectWithMaxPowerGrad: False
      estimateZernikes.binning: 2
      donutStampSelector.minSignalToNoise: 100
